generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * Enums
 * =========================
 */
enum Role {
  ADMIN
  STAFF
  CUSTOMER
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  SOLD
  DRAFT
  ARCHIVED
}

enum ProductCondition {
  NEW_WITH_TAGS
  LIKE_NEW
  GREAT
  GOOD
  FAIR
}

enum DiscountType {
  PERCENT
  AMOUNT
}

enum OrderStatus {
  PENDING
  CONFIRMED
  FULFILLED
  CANCELED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  AWAITING_CONFIRMATION   // thêm mới
  PAID
  FAILED
  REFUNDED
}

/**
 * =========================
 * Core Models
 * =========================
 */
model User {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String
  name         String?
  role         Role    @default(CUSTOMER)
  phone        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
  carts  Cart[]
}

model Brand {
  id       String    @id @default(cuid())
  name     String
  slug     String    @unique
  products Product[]
}

model Category {
  id       String     @id @default(cuid())
  name     String
  slug     String     @unique
  parentId String?
  parent   Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children Category[] @relation("CategoryToCategory")
  products Product[]
}

model Product {
  id          String  @id @default(cuid())
  sku         String  @unique
  title       String
  description String?
  bandName    String?
  brandId     String?
  brand       Brand?  @relation(fields: [brandId], references: [id])

  productTypeId String?
  productType   ProductType? @relation(fields: [productTypeId], references: [id])

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  condition ProductCondition?

  conditionLabel       String?
  conditionValue       String?
  conditionDescription String?

  material String?
  color    String?

  size String?
  sizeLabel String? @map("size_label") // nếu cột DB là snake_case
  sizeOptionId String?
  sizeOption   SizeOption? @relation(fields: [sizeOptionId], references: [id])

  weight Int?

  retailPrice          Int?
  estimatedPriceSource String?
  oldPrice             Int
  price                Int
  discountPercent      Int?

  ecoImpactGroup     String?
  ecoGlassesOfWater  Float?
  ecoHoursOfLighting Float?
  ecoKmsOfDriving    Float?

  status    ProductStatus @default(ACTIVE)
  createdAt DateTime      @default(now())

  images     ProductImage[]
  inventory  Inventory?
  orderItems OrderItem[]
  cartItems  CartItem[]

  favoritesCount Int @default(0)

  @@index([status, createdAt])
  @@index([status, price])
  @@index([brandId])
  @@index([categoryId])
  @@index([productTypeId])
  @@index([sizeOptionId])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  url      String
  thumb    String?
  alt      String?
  features String[]

  width      Int?
  height     Int?
  order      Int     @default(0)
  is360      Boolean @default(false)
  spriteCols Int?
  spriteRows Int?

  @@index([productId, order])
}

model Inventory {
  id        String  @id @default(cuid())
  productId String  @unique
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int     @default(1)
  location  String?
}

model Cart {
  id        String    @id @default(cuid())
  userId    String?   @unique
  anonId    String?   @unique
  expiresAt DateTime?
  user      User?     @relation(fields: [userId], references: [id])

  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([anonId])
  @@index([userId])
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int     @default(1)
  unitPrice Int

  @@unique([cartId, productId])
  @@index([productId])
}

model DiscountCode {
  id                String       @id @default(cuid())
  code              String       @unique
  type              DiscountType
  value             Int
  minSubtotal       Int?
  firstPurchaseOnly Boolean      @default(false)
  startsAt          DateTime?
  endsAt            DateTime?
  maxRedemptions    Int?
  used              Int          @default(0)
}

model Order {
  id          String      @id @default(cuid())
  orderCode   String      @unique
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  status      OrderStatus @default(PENDING)
  subtotal    Int
  discount    Int         @default(0)
  shippingFee Int         @default(0)
  tax         Int         @default(0)
  total       Int
  currency    String      @default("VND")
  createdAt   DateTime    @default(now())

  items    OrderItem[]
  payments Payment[]

  @@index([createdAt])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int     @default(1)
  unitPrice Int
}

model Payment {
  id          String        @id @default(cuid())
  orderId     String
  order       Order         @relation(fields: [orderId], references: [id])
  provider    String
  txnId       String?
  amount      Int
  status      PaymentStatus @default(PENDING)
  payloadJson String?
  createdAt   DateTime      @default(now())

  @@index([createdAt])
}

model ProductType {
  id       String        @id @default(cuid())
  name     String        @unique
  nameVi   String
  parentId String?
  parent   ProductType?  @relation("ProductTypeParent", fields: [parentId], references: [id])
  children ProductType[] @relation("ProductTypeParent")

  products Product[]

  ecoImpact EcoImpact?
}

model SizeOption {
  id        String  @id @default(cuid())
  sortOrder Int
  sizeLabel String
  us        String?
  uk        String?
  kr        String?
  jp        String?
  eu        String?

  products Product[]

  @@unique([sizeLabel, sortOrder], name: "sizeLabel_sortOrder")
}

model EcoImpact {
  id              String @id @default(cuid())
  productGroup    String @unique
  glassesOfWater  Float
  hoursOfLighting Float
  kmsOfDriving    Float

  productTypeId String?      @unique
  productType   ProductType? @relation(fields: [productTypeId], references: [id])
}
